{% load static %}
{% load account %}
<!DOCTYPE html>
<html>
<head>
<title>Edit Profile | Kona Equity</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"><!-- CSS only -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<link rel="icon" href="{% static 'profile_photos/favicon.ico' %}" type="image/gif" sizes="32x32">
<link rel="apple-touch-icon" href="{% static 'profile_photos/logo.png' %}">
<link rel="stylesheet" href="{% static 'css/find.css' %}">
<link rel="stylesheet" href="{% static 'css/about.css' %}">
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
<link rel="stylesheet" href="{% static 'css/loading.css' %}">
<link rel="stylesheet" href="{% static 'css/menusearch.css' %}">

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-163184927-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-163184927-1');
</script>
<script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "56y5lp4wnt");
</script>
<script src="{% static 'js/lazysizes.min.js' %}" async></script>
<form id="logout" method="post" action="{% url 'account_logout' %}">
    {% csrf_token %}
    {% if redirect_field_value %}
      <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}"/>
    {% endif %}
</form>
</head>

<body>
    <style>
    a.strtedcon:hover{
        color: white;
    }
    a.strtedcon{
        cursor: pointer;
    }
    .some-text {
        margin-top: 3%;
    }
    .middle-boi {
        margin-top: 4rem;
        margin-bottom: 4rem;
    }
    .rounded-style-1 {
      border-radius: 30px;
    }

    input[type='text'], input[type="password"]{
        color: black;
        font-size: 18px;
        height: 3rem;
        font-weight: 450;
        font-family: std-medium;
        background-color: white;
        border-color: rgba(0,0,0,0.3);
        border-radius: 30px;
        opacity: 1;
    }
    input[type="text"]:focus, input[type="password"]:focus {
        color: black;
        font-size: 18px;
        font-family: std-medium;
        font-weight: 450;
        background-color: white;
        border-color: rgba(0,0,0,0.3);
        border-radius: 30px;
        opacity: 1;
    }
    .form-control:valid + .valid-mark {
        display:block;
    }
    .form-control:invalid + .valid-mark + .invalid-mark {
        display:block;
    }
    .form-control:valid + .valid-mark + .invalid-mark {
        display:none;
    }
    .form-control:invalid + .valid-mark {
        display:none;
    }
    .markk {
        position: absolute;
        right: 1.25rem;
        top: 30%;
        background-color: transparent;
    }
    .mark2 {
        position: absolute;
        right: 1.25rem;
        top: 34.5%;
        background-color: transparent;
    }

    @media only screen and (max-width: 768px){
        .markk {
            position: absolute;
            right: 1.25rem;
            top: 31%;
            background-color: transparent;
        }
        .mark2 {
            position: absolute;
            right: 1.25rem;
            top: 35%;
            background-color: transparent;
        }
    }
    #save, #contact {
        height: 4rem;
    }
    #notification-p{
        display:none;

    }
    .container-fluid.row.menu-top{
        background-color:#00D1C1;
    }
</style>

<div id="myNav" class="overlay">
    <a href="/" class="hidden-logo"><img src="{% static 'profile_photos/blue-logo.svg' %}"></a>
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()"><img src="{% static 'web_photos/menu-close.svg' %}"></a>
    <div class="overlay-content">
        <a href="#" class="current-selection">Home</a>
        <a href="/about/">About</a>
        <a href="/contact/">Contact us</a>
        <div class="just-there">
            <input id="id_input" class="search-box form-control" type="text" placeholder="Search" >
        </div>
    </div>
</div>

<div class="container-fluid row menu-top">
    <div class="wex"></div>
    <div class="logo-home"><a href="/"><img src="{% static 'profile_photos/logo.png' %}"></div></a>
    <div style="width: 7%;"></div>
    <div id="menu-bar" class="row">
        <div class="navnone">
            <div class="about-hover row quart">
                <a href="/about/">About</a>
            </div>
        </div>
        <div class="ex-spacing"></div>
        <div>
            <div class="search-hover row quart">
                <a href="/find/">Explore</a>
            </div>
        </div>
        <div class="ex-spacing"></div>
        <div>
            <div class="search-hover row quart">
                <a href="/premium/">Premium</a>
            </div>
        </div>
        <div class="ex-spacing"></div>
        <div>
            <div class="contact-hover row quart">
                <a href="/contact/">Contact us</a>
            </div>
        </div>
    </div>
    <div id="hidden-menu" class="col-1" style="padding-left: 10%;">
        <a onclick="openNav()"><img src="{% static 'web_photos/mobile-menu.svg' %}"></a>
    </div>
    {% if rauth is None %}
    <button id="login" type="button" data-toggle="modal" data-target="#LoginModal" class="quart my-auto pbot cuta"><span class="hvra">Login</span></button>
    <button id="signup" type="button" data-toggle="modal" data-target="#SignupModal" class="quart my-auto pbot bbpotp hvra">Sign up</button>
    {% else %}
    <div id="profile-disp" class="my-auto">
        <img id="profile-img" class="my-auto" src="/media/{{rauth}}" onerror="this.src='/static/profile_photos/default-avatar.svg'">
        <svg width="20" height="8" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4.87903 5.81354L0.548901 0.563538L9.20916 0.563538L4.87903 5.81354Z" fill="white"/>
        </svg>
        <div id="profile-menu" class="dropdown-content">
            <a href="/dashboard/">Edit Profile</a>
            <a href="/watchlist/">My Watchlist</a>
            <a id="logmeout" href="JavaScript:Void(0);">Logout</a>
        </div>
    </div>

    {% endif %}

    <div class="container-fluid intro-about">
        <div id="dynamis-d" class="row">
            <div class="wex"></div>
            <div class="col-lg-5 some-text p-0">
                <h1 class="m-text">
                    Profile
                </h1>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid middle-boi">
    <div class="row justify-content-center">
        <div class="col-11">
            <div class="card shadow border-radius rounded-style-1">
                <div class="card-body" style="padding: 5rem 4rem;">
                        <div class="row">
                            <div class="col-12 col-lg-6 pr-4 pl-4 pb-0">
                                <form id="update_form" method="post" action="{% url 'update_profile' %}" enctype='multipart/form-data'>
                                    {% csrf_token %}
                                    <div class="form-row">
                                        <div class="form-group col-12 col-lg-6 col-xl-4">
                                            <div class="col-12 p-0 pt-2" id="profile-picture" data-toggle="popover" data-placement="bottom">
                                                <div class="embed-responsive embed-responsive-1by1 defcol">
                                                    <img class="embed-responsive-item" src="/media/{{rauth}}" onerror="this.src='/static/profile_photos/default-avatar.svg'">
                                                  </div>
                                                  <input type="file" style="position:absolute;" class="custom-file-input" id="id_profile_photo" name="profile_photo">
                                                <button type="button" class="btn-outline-primary btn-block btn jguj" id="file-upload-button">Add photo</button>
                                            </div>
                                        </div>
                                        <div class="form-group col-12 col-lg-6 col-xl-8 d-flex align-content-between flex-wrap">
                                            <div class="form-group col-12">
                                                <label for="id_first_name">First Name:</label>
                                                <div class="styledTB">
                                                    <input type="text" class="logforms capinames" autocomplete="off" name="first_name" max-length="30" style="border: 2px solid #8CE071;" value="{{user.first_name}}" required id="id_first_name">
                                                    <div class="searchBDir correct"></div>
                                                    </div>
                                                <p id="first_name_errors"></p>
                                            </div>
                                            <div class="form-group col-12">
                                                <label for="id_last_name">Last Name:</label>
                                                <div class="styledTB">
                                                <input type="text" class="logforms capinames" autocomplete="off" name="last_name" max-length="30" style="border: 2px solid #8CE071;" value="{{user.last_name}}" required id="id_last_name">
                                                <div class="searchBDir correct"></div>
                                                </div>
                                                <p id="last_name_errors"></p>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="col-12 col-lg-6 pl-4 pr-4 pb-0">
                                <div class="row pb-0 h-100">
                                    <div class="col-12 d-flex align-content-between flex-wrap">
                                        <form id="password_form" class="w-100">
                                            {% csrf_token %}
                                            <div class="form-group col-12">
                                                <label for="id_oldpassword">Current Password:</label>
                                                <div class="styledTB">
                                                <input type="password" class="logforms" name="oldpassword" style="border: 1px solid rgba(56, 56, 56, 0.3);" autocomplete="new-password" onchange="pass_field_change()" id="id_oldpassword">
                                                <div id="pwdo" class="searchBDir pwd-thingy"></div>
                                                </div>
                                                <p id="oldpassword_errors"></p>
                                            </div>
                                            <div class="form-group col-12">
                                                <label for="id_password1">New Password:</label>
                                                <div class="styledTB">
                                                <input type="password" class="logforms" name="password1" style="border: 1px solid rgba(56, 56, 56, 0.3);" onchange="pass_field_change()" autocomplete="new-password"  id="id_password1">
                                                <div id="pwd1" class="searchBDir pwd-thingy"></div>
                                                </div>
                                                <p id="password1_errors"></p>
                                            </div>
                                            <div class="form-group col-12">
                                                <label for="id_password2">Confirm Password:</label>
                                                <div class="styledTB">
                                                <input type="password" class="logforms" name="password2" style="border: 1px solid rgba(56, 56, 56, 0.3);" onchange="pass_field_change()" autocomplete="new-password"  id="id_password2">
                                                <div id="pwd2" class="searchBDir pwd-thingy"></div>
                                                </div>
                                                <p id="password2_errors"></p>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 col-lg-6 pl-4 pr-4 pt-0">
                                <div class="form-group col-12 pr-0 pl-0 pt-0 m-0">
                                    <div class="col-12">
                                        <label for="id_email">Business Email:</label></br>
                                        <div class="styledTB">
                                        <input type="text" class="logforms emaily" name="email" style="border: 2px solid #8CE071;" autocomplete="off" required id="id_email" value="{{user.email}}">
                                        <div class="searchBDir correct"></div>
                                        </div>
                                        <p id="email_errors"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6 pr-4 pl-4 pt-0 pb-0">
                                <div class="row h-100">
                                    <div class="col-12 my-auto">
                                        <div class="row pl-4">
                                            <div class="col-6 mipadi mx-auto my-auto" style="padding:0;">
                                                <div id="disabled" class="strtedcon" style="width: 70%; padding: 6% 0;">
                                                    Save
                                                </div>
                                            </div>
                                            <div class="col-6 mipadi my-auto" style="padding:0;">
                                                <a href="/contact/" class="strtedcon mx-auto" style="width: 70%; padding: 6% 0; opacity: 1; display: block;">
                                                    Contact
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="notification" style="display: none;">
    <span class="dismiss"><a title="dismiss this notification">x</a></span>
</div>
<div id="notification-p">
    <span class="dismiss"><a title="dismiss this notification">x</a></span>
</div>
<div class="container-fluid footer p-0">
    <div class="row footer-clear">
        <div class="wex"></div>
        <div class="logo-home footer-logo"><a href="/"><img src="{% static 'profile_photos/logo.png' %}" alt="Kona equity logo"></div></a>
        <div class="excess" style="width: 9.92%;"></div>
        <div id="footer-menu-bar" class="row">
            <div>
                <div class="row quart">
                    <a href="/">Home</a>
                </div>
            </div>
            <div class="spacing excess"></div>
            <div>
                <div class="row quart">
                    <a class="" href="/about/">About</a>
                </div>
            </div>
            <div class="spacing excess"></div>
            <div>
                <div class="row quart">
                    <a href="/contact/">Contact Us</a>
                </div>
            </div>
            <div class="ex-spacing excess"></div>
            <div>
                <div class="row quart">
                    <a href="/privacy/">Privacy Policy</a>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center enuf enufh">Explore popular industries</div>
    <div class="row lcomp">
        {% for a in dc %}
        <a href="{{a.link}}" class="text-center enugl col-lg-2 col-md-4 col-sm-6">{{a.name}}</a>
        {% endfor %}
    </div>
    <div class="row year-footer">
        <span class="col-12">2022</span>
    </div>
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script src="{% static 'js/freemails.js' %}"></script>
<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/autocomplete.js' %}"></script>
</script>
<script>
    $(document).ready(function(){

    dropys();
    var inp = document.getElementById("id_input")
    autocomplete(inp);
    Url = "{% url 'ajax_autocomplete' %}"

    logmeout();
    validato();
    var loadingTag = '<div style="color: #ffffff" class="la-ball-scale-pulse mx-auto my-auto"><div></div><div></div></div>'
    $(".markk").each(function(){
        this.height = $("#id_oldpassword").outerHeight() - 10;
        this.width = $("#id_oldpassword").outerHeight() - 10;
    });
    $(".mark2").each(function(){
        this.height = $("#id_oldpassword").outerHeight() - 10;
        this.width = $("#id_oldpassword").outerHeight() - 10;
    });
    $('#disabled').click(function(){
        if(nameValidate()){
            create_post();
        }
        if(passValidate()){
            change_password();
        }
    });
    $("#some").trigger("click");
    $("#file-upload-button").click(function(){
        console.log("clicked!");
        $("#id_profile_photo").trigger('click');
    });
    $('#id_profile_photo').change( function(e) {
        var img = URL.createObjectURL(e.target.files[0]);
        $('#profile-picture img').attr('src', img);
    });
    var kimer;
        $("#update_form input, #id_email").on("input", function(){
		    clearTimeout(kimer);
            var ms = 200;
            kimer = setTimeout(function() {
                if(nameValidate()){
                    $("#disabled").addClass("enableCont");
                }
                else{
                    $("#disabled").removeClass("enableCont");
                }
            }, ms);
        });
        $("#password_form input").on("input", function(){
		    clearTimeout(kimer);
            var ms = 200;
            kimer = setTimeout(function() {
                if(passValidate()){
                    $("#disabled").addClass("enableCont");
                }
                else{
                    $("#disabled").removeClass("enableCont");
                }
            }, ms);
        });
    });

    function create_post() {
    var fd = new FormData($("#update_form").get(0));
    var email = $("#id_email").val();
    fd.append("email", email);
    for (var pair of fd.entries()) {
        console.log(pair[0]+ ', ' + pair[1]);
    }
    $.ajax({
        headers: { "X-CSRFToken": "{{csrf_token}}" },
        url : "{% url 'update_profile' %}",
        type : "POST",
        contentType: false,
        processData: false,
        data : fd,
        success: function(response) {
            console.log(response);
            var jsonResponse = response;
            if(response["errors"]=="None"){
                console.log(response["pp"])
                $("#profile-img").attr("src", "/media/" +response["pp"]);
                $("#notification").fadeIn("slow").append('Changes saved.');
                $("#notification").delay(1500).fadeOut("slow");
                $(".dismiss").click(function(){
                    $("#notification").fadeOut("slow");
                });
            }
            $("input").each(function(){
            var name = $(this).attr("name");
            if(name == "csrfmiddlewaretoken")
                return;
            for(x in jsonResponse["errors"][name]){
                var error = jsonResponse["errors"][name][x];
                $("#"+name+"_errors").append(error + '\n');
            }
            })
        },
        error: function(response){
        }
    });
    }
    function change_password() {
        var fd = new FormData($("#password_form").get(0));
        $.ajax({
            url : "{% url 'account_change_password' %}",
            type : "POST",
            contentType: false,
            processData: false,
            data : fd,
            success: function(response) {
                console.log(response);
            var jsonResponse = response;
            if(response["errors"]=="None"){
                $("#notification-p").fadeIn("slow").append('Password changed.');
                $("#notification-p").delay(1500).fadeOut("slow");
                $(".dismiss").click(function(){
                    $("#notification-p").fadeOut("slow");
                });
            }
            $("input").each(function(){
                var name = $(this).attr("name");
                console.log(name);
                if(name == "csrfmiddlewaretoken")
                return;
                for(x in jsonResponse["errors"][name]){
                var error = jsonResponse["errors"][name][x];
                $("#"+name+"_errors").append(error + '\n');
                }
            })
            },
            error: function(response){
                console.log(response)
            }
        });
    }

    function pass_field_change() {
        var passwords = document.querySelectorAll("input[type='password']");
        var length = passwords.length;
        var flag= true;

        for(var i = 0; i < length; i++) {
            if(passwords[i].value.length != 0) {
                flag=false;
            }
        }

        if(flag) {
            for(var i = 0; i < length; i++) {
                passwords[i].required = false;
                passwords[i].setAttribute("pattern", ".{0.}");
            }
        }
        else
        {
            for(var i = 0; i < length; i++) {
                passwords[i].required = true;
                passwords[i].setAttribute("pattern", "(?=.*\\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[a-zA-Z]).{8,}");
            }
        }
    }

    function openNav() {
    document.getElementById("myNav").style.height = "100%";
    element = document.getElementsByTagName("body")[0];
    element.classList.add("noscroll");
    }

    function closeNav() {
    document.getElementById("myNav").style.height = "0%";
    element = document.getElementsByTagName("body")[0];
    element.classList.remove("noscroll");
    }
    function handleFileSelect(evt) {
	reader = new FileReader();
    reader.onloadstart = function(){
        var k = $("#file-upload-button");
        console.log("Hello");
        $(k).html("Loading...");
        $(k).css("background-color", "#00D1C1");
        $(k).css("opacity", 0.5);
        $(k).css("border-color", "#00D1C1");
    }
    reader.onload = function(e){
        var k = $("#file-upload-button");
        $('#profile-picture').attr('src', e.target.result);
        setTimeout(function(){
            if (Validate(document.getElementById("id_profile_photo"))){
            $(k).html("Done");
            $(k).css("background-color", "#8CE071");
            $(k).css("opacity", "1.0");
            $(k).css("border-color", "#8CE071");
        }
        else{
            $(k).html("Add photo");
            $(k).css("background-color", "#FF5A5F");
            $(k).css("opacity", "1.0");
            $(k).css("border-color", "#FF5A5F");
        }
        }, 350)
    }
    reader.readAsDataURL(evt.target.files[0]);
}

function nameValidate(){
    var fn = $("#id_first_name").val();
    var ln = $("#id_last_name").val();
    var em = $("#id_email").val();
    var orig = "{{rauth}}"
    if (orig == ""){
        orig = "/static/profile_photos/default-avatar.svg"
    }

    if(fn != "{{user.first_name}}" || ln !="{{user.last_name}}" || em != "{{user.email}}" || $("#profile-picture img").attr("src") != orig){
        if(fn != "" && ln != "" && em != "" && Validate(document.getElementById("id_profile_photo")) && /(.+)@(.+){2,}\.(.+){2,}/.test(em)
            && !freeEmails.includes(em.split("@")[1])){
            return true
        }
    }
    return false
}
</script>
</html>
